<div align="center">

# 🎯 追蹤（Tracing）

</div>

<div align="center">

</div>

## 🟢 追蹤功能可以幫你做什麼
✅ **記錄每次運行**
- 用戶輸入了什麼問題
- 老師如何優化問題
- 學生（各模型）的回答
- 評分結果

✅ **比較不同模型表現**
- 哪個模型回答最好
- 回答速度比較
- 成本比較
- 歷史趨勢

✅ **調試和優化**
- 查看每個節點的輸入輸出
- 發現哪裡出錯
- 優化 Prompt 效果

✅ **數據分析**
- 統計最常被問的問題
- 分析用戶行為
- 評估系統效能

---

## 📊 推薦平台選擇

### 🏆 首選：Langfuse

**為什麼：**
- ✅ **免費開源**
- ✅ **支援評分功能**（可以記錄模型分數）
- ✅ **提供詳細的追蹤視圖**
- ✅ **有數據分析儀表板**
- ✅ **可以比較不同運行結果**
- ✅ **支援標註和評估**

---

### 🥈 次選：LangSmith

**優點：**
- ✅ 功能最完整
- ✅ UI 很好用
- ✅ 由 LangChain 官方提供

**缺點：**
- ❌ 免費額度有限
- ❌ 需要註冊 LangChain 帳號

---

### **🥉 其他選項：**

- **Opik**：完全免費，但功能較基礎
- **Weave**：適合實驗性項目
- **阿里雲/騰訊雲**：如果你在中國，延遲低

---

## 🛠️ 配置步驟（以 Langfuse 為例）

### Step 1: 註冊 Langfuse 帳號

1. 前往 [https://langfuse.com](https://langfuse.com)
2. 點擊 "Sign Up" 註冊（免費）
3. 創建一個新項目

---

### Step 2: 獲取 API 金鑰

1. 在 Langfuse 後台，進入 **Settings** → **API Keys**
2. 點擊 "Create new API key"
3. 複製以下三個值：
   ```
   Public Key: pk-lf-xxxxx
   Secret Key: sk-lf-xxxxx
   Host: https://cloud.langfuse.com (或自定義)
   ```

---

### Step 3: 在 Dify 中配置

#### **方式 A：在應用層級配置**

1. **打開你的工作流應用**
2. **點擊右上角「⚙️ 設定」或「監控」**
3. **找到「追蹤」或「Tracing」選項**
4. **點擊「配置」**
5. **選擇 Langfuse**
6. **填入資訊：**
   ```yaml
   Public Key: [貼上你的 pk-lf-xxxxx]
   Secret Key: [貼上你的 sk-lf-xxxxx]
   Host: https://cloud.langfuse.com
   ```
7. **啟用追蹤**
8. **保存**

---

#### **方式 B：在全局設定配置**

1. **進入 Dify 工作台首頁**
2. **點擊右上角頭像 → 設定**
3. **找到「整合」或「Integrations」**
4. **選擇「追蹤平台」**
5. **配置 Langfuse**

---

### Step 4: 測試追蹤

1. 運行你的工作流
2. 完成後，前往 Langfuse 後台，進入你的項目
3. 查看追蹤記錄
   - 在 **Traces** 頁面會看到剛才的運行記錄
---

## 📊 在 Langfuse 中你能看到什麼

### 1. 追蹤視圖（Traces）
```
運行 ID: xxxxx
時間: 2024-01-01 10:30:25
總耗時: 15.3秒
狀態: ✅ 成功

├─ 開始節點
│  └─ 輸入
│
├─ LLM-老師 (秒, $)
│  ├─ 輸入
│  └─ 輸出
│
├─ 代碼執行 (秒)
│  ├─ 輸入
│  └─ 輸出
│
└─ 結束
   └─ 輸出
```

### 2. 指標儀表板（Metrics）
- 總運行次數
- 平均響應時間
- 成功率
- 總成本
- Token 使用量

### 3. 評分功能（Scores）
可以記錄：
- 老師給每個學生的評分
- 用戶滿意度
- 回答質量評分

---

## 🔍 實用場景

### **場景 1：優化 Prompt**
1. 運行 10 次相同問題
2. 在 Langfuse 查看結果
3. 比較哪個 Prompt 版本效果更好

### **場景 2：監控成本**
1. 追蹤每次運行的成本
2. 發現哪個模型最貴
3. 優化模型選擇

### **場景 3：分析用戶行為**
1. 看用戶最常問什麼類型的問題
2. 哪些問題最難回答
3. 調整系統針對性優化

### **場景 4：A/B 測試**
1. 測試不同的老師 Prompt
2. 比較效果
3. 選擇最佳版本

---

## 🎁 Langfuse 免費額度

```yaml
免費版包含:
  - 無限追蹤記錄（保存 30 天）
  - 所有核心功能
  - 1 個項目
  - 社群支援

付費版:
  - 更長保存期
  - 更多項目
  - 團隊協作
  - 優先支援
```

## 📚 數據流程：
1. Dify 執行工作流 → 每個節點運行時
2. 自動發送數據 → 通過 Langfuse SDK
3. 雲端儲存 → 結構化保存所有資訊
4. 實時分析 → 生成可視化報表
5. 你查看和分析 → 通過 Web 介面

